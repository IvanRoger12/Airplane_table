<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AirFlow Dynamics - Global Air Traffic Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts/map/js/world.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --bg-dark: #0a1929;
            --bg-card: rgba(10, 25, 41, 0.5);
            --accent-cyan: #00bcd4;
            --accent-blue: #64b5f6;
            --accent-green: #4caf50;
            --text-white: #e6f1ff;
            --text-muted: #8892b0;
            --border-color: rgba(0, 188, 212, 0.2);
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-white);
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: radial-gradient(ellipse at top left, rgba(0, 188, 212, 0.1), transparent 50%),
                              radial-gradient(ellipse at bottom right, rgba(100, 181, 246, 0.1), transparent 50%);
            z-index: -1;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 1rem;
            position: relative;
            z-index: 1;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo svg {
            width: 40px;
            height: 40px;
            color: var(--accent-cyan);
        }

        .logo-text {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .logo-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: -5px;
        }
        
        .main-nav {
            display: flex;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 99px;
            backdrop-filter: blur(10px);
            padding: 0.25rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border-radius: 99px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            position: relative;
        }

        .nav-tab.active, .nav-tab:hover {
            background-color: var(--accent-cyan);
            color: var(--bg-dark);
            box-shadow: 0 0 20px rgba(0, 188, 212, 0.5);
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .lang-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: none;
            color: var(--text-white);
            cursor: pointer;
            font-size: 1rem;
            position: relative;
            padding: 0.5rem;
        }

        .lang-toggle:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,188,212,0.3);
            border-radius: 8px;
        }
        
        .btn {
            background-color: var(--accent-cyan);
            color: var(--bg-dark);
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(0, 188, 212, 0.3);
        }
        
        .btn:active {
            transform: translateY(-1px);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: 3fr 1fr;
            }
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .filters-card {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }
        
        .filter-group {
            flex-grow: 1;
        }
        
        .filter-label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .filter-select {
            width: 100%;
            background-color: rgba(10, 25, 41, 0.8);
            color: var(--text-white);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2300bcd4' class='bi bi-chevron-down' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708 .708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
        }
        
        /* FIX: Dropdown options visibility */
        .filter-select option {
            background-color: var(--bg-dark);
            color: var(--text-white);
        }
        
        .filter-select:hover {
            background: rgba(0,188,212,0.1);
            border-color: var(--accent-cyan);
        }

        .filter-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0,188,212,0.3);
            transform: scale(1.02);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--accent-cyan);
            border: 1px solid var(--accent-cyan);
        }

        .btn-secondary:hover {
            background-color: rgba(0,188,212,0.1);
            box-shadow: none;
            transform: translateY(0);
        }
        
        #chart-container {
            min-height: 600px;
            position: relative;
        }

        .chart {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            opacity: 1;
            transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
            transform: scale(1);
        }

        .chart.hidden {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
        }
        
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* NEW: Insight Card */
        .insight-card {
            border-color: var(--accent-blue);
            text-align: center;
        }
        .insight-title {
            font-weight: bold;
            color: var(--accent-blue);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        #insight-text {
            font-size: 0.95rem;
            min-height: 50px;
            color: var(--text-white);
        }

        /* NEW: AI Prediction Card */
        .ai-card {
             border-color: var(--accent-green);
        }
        .ai-title {
            font-weight: bold;
            color: var(--accent-green);
            margin-bottom: 0.75rem;
        }
        #ai-prediction-text {
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }
        .confidence-bar-container {
            width: 100%;
            height: 8px;
            background-color: rgba(76, 175, 80, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }
        #confidence-bar {
            width: 92%; /* Example confidence */
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            border-radius: 4px;
        }

        .metric-card {
            position: relative;
            overflow: hidden;
            border-width: 1px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .metric-icon {
            font-size: 1.75rem;
            color: var(--accent-cyan);
            opacity: 0.7;
            padding-right: 1rem;
            border-right: 1px solid var(--border-color);
        }
        
        .metric-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--accent-cyan);
            transition: all 0.3s ease;
        }
        
        .metric-subtext {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            min-height: 1.2rem;
            line-height: 1.2rem;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(10, 25, 41, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease;
        }

        .loader {
            width: 50px;
            aspect-ratio: 1;
            border-radius: 50%;
            border: 8px solid;
            border-color: #0000 #00bcd4;
            animation: l1 1s infinite;
        }
        @keyframes l1 {to{transform: rotate(.5turn)}}

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .footer {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 2rem;
        }
        
        .god-view-banner, .achievement-toast {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--accent-cyan);
            color: var(--bg-dark);
            padding: 0.5rem 2rem;
            border-radius: 50px;
            font-weight: bold;
            z-index: 9999;
            animation: fadeInDown 0.5s ease;
            box-shadow: 0 10px 30px rgba(0, 188, 212, 0.6);
        }
        
        .achievement-toast {
             background-color: var(--accent-green);
             box-shadow: 0 10px 30px rgba(76, 175, 80, 0.6);
        }

        #badges-container {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }
        
        .badge {
            font-size: 1.5rem;
            opacity: 0.5;
            transition: all 0.3s ease;
            filter: grayscale(1);
        }
        .badge.unlocked {
            opacity: 1;
            transform: scale(1.1);
            filter: grayscale(0);
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translate(-50%, -100%); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @media (hover: hover) and (min-width: 1024px) {
            .metric-card:hover {
                transform: translateY(-4px) scale(1.02);
                box-shadow: 0 15px 30px rgba(0,188,212,0.25);
                border-color: var(--accent-cyan);
                background: radial-gradient(circle at center, rgba(0,188,212,0.1) 0%, rgba(10, 25, 41, 0.5) 100%);
            }

            .metric-card::before {
                content: '';
                position: absolute;
                top: 0;
                left: -150%;
                width: 50%;
                height: 100%;
                background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0) 100%);
                transform: skewX(-25deg);
                transition: left 0.75s;
            }

            .metric-card:hover::before {
                left: 150%;
            }

            .metric-value:hover {
                color: #fff;
                text-shadow: 0 0 15px var(--accent-cyan);
                transform: scale(1.05);
                display: inline-block;
            }
        }
        
        @media (max-width: 1023px) {
            .metric-card {
                transition: none;
            }
        }
        
        /* Pimper les tabs + badges */
        .main-nav { box-shadow: 0 8px 24px rgba(0,0,0,.25); }
        .nav-tab { letter-spacing:.2px; border:1px solid rgba(255,255,255,.08); }
        .nav-tab.active { background:linear-gradient(135deg,#0f3b4c,#00bcd4); color:#02131b; }
        /* Cartes + relief */
        .card { box-shadow: 0 20px 50px rgba(2,6,12,.4), inset 0 1px 0 rgba(255,255,255,.04); }
        .metric-card { background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)); }
        /* KPI number gradient */
        .metric-value {
            background: linear-gradient(90deg,#00bcd4 0%,#64b5f6 100%);
            -webkit-background-clip: text; background-clip: text; color: transparent;
        }
        /* Sélecteurs plus premium */
        .filter-select {
            background: radial-gradient(120% 120% at 0% 0%, rgba(0,188,212,.08) 0%, rgba(10,25,41,.8) 60%);
            border-color: rgba(0,188,212,.25);
        }
        /* Transition d’apparition charts */
        .chart { transition: opacity .4s ease, transform .4s ease; will-change: transform,opacity; }

    </style>
</head>
<body>
    <div id="loading-overlay" class="loading-overlay">
        <div class="loader"></div>
    </div>
    
    <div id="dashboard-content" class="container">
        <header class="header">
            <div class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M10.18 9.09C7.21 8.32 5.37 6.41 5.37 4.17 5.37 1.86 7.24 0 9.56 0c2.31 0 4.18 1.86 4.18 4.17 0 2.24-1.84 4.15-4.81 4.92L10.18 9.09zm11.32 7.27c-2.48-1.5-5.11-2.6-7.85-3.18l-1.9-4.86c3.27-.78 5.6-3.04 5.6-5.82C17.35 1.12 15.34 0 12.91 0s-4.44 1.12-4.44 2.5c0 2.78 2.33 5.04 5.6 5.82l-1.9 4.86c-2.74.58-5.37 1.68-7.85 3.18C1.55 17.81 0 19.86 0 22.1v.51c0 .81.6 1.48 1.39 1.48h21.22c.79 0 1.39-.67 1.39-1.48v-.51c0-2.24-1.55-4.29-4.25-5.74z"></path></svg>
                <div>
                    <h1 class="logo-text" data-key="title">AirFlow Dynamics</h1>
                    <p class="logo-subtitle" data-key="subtitle">Global Air Traffic Intelligence</p>
                </div>
            </div>
            
            <nav class="main-nav">
                <div class="nav-tab active" id="tab-map" data-key="visualSynthesis">Synthèse Visuelle</div>
                <div class="nav-tab" id="tab-analytics" data-key="detailedAnalytics">Analyses Détaillées</div>
            </nav>

            <div class="controls">
                <button class="lang-toggle" id="lang-toggle" title="Switch language">
                    <span id="lang-fr">FR</span> / <span id="lang-en" style="opacity: 0.5;">EN</span>
                </button>
                <button class="btn" id="export-pdf-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>
                    <span data-key="exportPDF">Exporter en PDF</span>
                </button>
                <button class="btn btn-secondary" id="demo-btn" title="Run animation sequence for GIF capture">▶️ Demo</button>
            </div>
        </header>

        <main id="main-dashboard" class="dashboard-grid">
            <div class="main-content">
                <div class="card filters-card">
                    <div class="filter-group">
                        <label for="continent-select" class="filter-label" data-key="continent">Continent</label>
                        <select id="continent-select" class="filter-select">
                            <option value="all">All Continents</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="airline-select" class="filter-label" data-key="airline">Compagnie</label>
                        <select id="airline-select" class="filter-select">
                            <option value="all">All Airlines</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" id="reset-filters-btn" data-key="resetFilters">Réinitialiser</button>
                </div>
                <div class="card" id="chart-container">
                    <div id="map-chart" class="chart"></div>
                    <div id="analytics-chart" class="chart hidden"></div>
                </div>
            </div>

            <aside class="sidebar">
                <div class="card insight-card">
                    <h3 class="insight-title" data-key="insightTitle">💡 Insight du Jour</h3>
                    <p id="insight-text"></p>
                </div>

                <div class="card ai-card">
                    <h3 class="ai-title" data-key="aiTitle">🤖 Analyse Prédictive</h3>
                    <p id="ai-prediction-text"></p>
                    <div class="confidence-bar-container">
                        <div id="confidence-bar"></div>
                    </div>
                </div>

                <div class="card metric-card">
                    <span class="metric-icon">✈️</span>
                    <div>
                        <p class="metric-label" data-key="totalRoutes">Routes Totales Analysées</p>
                        <h2 id="total-routes" class="metric-value">0</h2>
                    </div>
                </div>
                <div class="card metric-card">
                    <span class="metric-icon">🏢</span>
                    <div>
                        <p class="metric-label" data-key="activeAirlines">Compagnies Aériennes</p>
                        <h2 id="active-airlines" class="metric-value">0</h2>
                    </div>
                </div>
                <div class="card metric-card">
                     <span class="metric-icon">🏆</span>
                     <div>
                        <p class="metric-label" data-key="topAirline">Compagnie Top 1</p>
                        <h2 id="top-airline" class="metric-value">-</h2>
                     </div>
                </div>
                <div class="card metric-card">
                    <span class="metric-icon">📍</span>
                    <div>
                        <p class="metric-label" data-key="busiestRoute">Route la Plus Fréquentée</p>
                        <h2 id="busiest-route" class="metric-value">-</h2>
                    </div>
                </div>
                 <div class="card metric-card">
                    <span class="metric-icon">📏</span>
                    <div>
                        <p class="metric-label" data-key="longestRoute">Route la plus Longue</p>
                        <h2 id="longest-route" class="metric-value">0 km</h2>
                    </div>
                </div>
            </aside>
        </main>
        
        <footer class="footer">
            <p data-key="footer">Vue d'ensemble data-driven (OpenFlights). KPIs, routes signatures et tendances.</p>
            <div id="badges-container">
                <span class="badge" id="badge-explorer" title="Explorateur de Données">🌍</span>
                <span class="badge" id="badge-analyst" title="Analyste Expert">📈</span>
                <span class="badge" id="badge-detective" title="Data Detective">🕵️‍♂️</span>
            </div>
        </footer>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const loadingOverlay = document.getElementById('loading-overlay');
            const mapChartEl = document.getElementById('map-chart');
            const analyticsChartEl = document.getElementById('analytics-chart');
            
            const tabMap = document.getElementById('tab-map');
            const tabAnalytics = document.getElementById('tab-analytics');
            const continentSelect = document.getElementById('continent-select');
            const airlineSelect = document.getElementById('airline-select');
            const resetFiltersBtn = document.getElementById('reset-filters-btn');
            const exportPdfBtn = document.getElementById('export-pdf-btn');
            const langToggle = document.getElementById('lang-toggle');
            const demoBtn = document.getElementById('demo-btn');
            const insightTextEl = document.getElementById('insight-text');
            const aiPredictionTextEl = document.getElementById('ai-prediction-text');

            // --- ECharts Instances ---
            let mapChart, analyticsChart;
            
            // --- State ---
            let allRoutesData = [];
            let currentLang = 'fr';
            let godView = false;
            const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
            let konamiIndex = 0;
            const achievements = {
                explorer: false,
                analyst: false,
                detective: false
            };


            // --- Translations & Dynamic Content ---
            const translations = {
                fr: {
                    title: "AirFlow Dynamics",
                    subtitle: "Intelligence du Trafic Aérien Mondial",
                    visualSynthesis: "Synthèse Visuelle",
                    detailedAnalytics: "Timeline & Tendances",
                    exportPDF: "Exporter en PDF",
                    continent: "Continent",
                    airline: "Compagnie",
                    resetFilters: "Réinitialiser",
                    totalRoutes: "Routes Analysées",
                    activeAirlines: "Compagnies Aériennes",
                    topAirline: "Compagnie Top 1",
                    busiestRoute: "Route la Plus Fréquentée",
                    longestRoute: "Route la plus Longue",
                    footer: "Vue d'ensemble data-driven (OpenFlights). KPIs, routes signatures et tendances.",
                    allContinents: "Tous les continents",
                    allAirlines: "Toutes les compagnies",
                    insightTitle: "💡 Insight du Jour",
                    aiTitle: "🤖 Analyse Prédictive",
                    aiPrediction: "L'IA prévoit +18% de trafic en Asie-Pacifique d'ici 2026 (Confiance: 92%).",
                    covidTimelineTitle: "Impact du COVID & Prédictions du Trafic Aérien",
                    achievementExplorer: "Badge débloqué : Explorateur de Données !",
                    achievementAnalyst: "Badge débloqué : Analyste Expert !",
                    achievementDetective: "Badge débloqué : Data Detective !",
                },
                en: {
                    title: "AirFlow Dynamics",
                    subtitle: "Global Air Traffic Intelligence",
                    visualSynthesis: "Visual Synthesis",
                    detailedAnalytics: "Timeline & Trends",
                    exportPDF: "Export as PDF",
                    continent: "Continent",
                    airline: "Airline",
                    resetFilters: "Reset",
                    totalRoutes: "Routes Analyzed",
                    activeAirlines: "Active Airlines",
                    topAirline: "Top #1 Airline",
                    busiestRoute: "Busiest Route",
                    longestRoute: "Longest Route",
                    footer: "Data-driven overview (OpenFlights). KPIs, route signatures and trends.",
                    allContinents: "All Continents",
                    allAirlines: "All Airlines",
                    insightTitle: "💡 Insight of the Day",
                    aiTitle: "🤖 Predictive Analysis",
                    aiPrediction: "AI predicts an 18% traffic increase in Asia-Pacific by 2026 (Confidence: 92%).",
                    covidTimelineTitle: "COVID Impact & Air Traffic Forecast",
                    achievementExplorer: "Badge unlocked: Data Explorer!",
                    achievementAnalyst: "Badge unlocked: Expert Analyst!",
                    achievementDetective: "Badge unlocked: Data Detective!",
                }
            };

            const insights = {
                fr: [
                    "Plus de 50% des routes analysées impliquent un aéroport en Europe ou en Amérique du Nord.",
                    "La route la plus longue de ce jeu de données pourrait faire 17 fois le tour de la lune.",
                    "Certaines petites compagnies n'opèrent qu'une seule route, reliant des communautés isolées.",
                    "Le nombre de routes aériennes a plus que doublé dans le monde au cours des 20 dernières années.",
                ],
                en: [
                    "Over 50% of analyzed routes involve an airport in Europe or North America.",
                    "The longest route in this dataset could circle the moon 17 times.",
                    "Some small airlines operate only a single route, connecting isolated communities.",
                    "The number of air routes worldwide has more than doubled in the last 20 years.",
                ]
            };
            
            // --- Utility Functions ---
            const animateCounter = (el, start, end, duration) => {
                if (start === end) {
                    el.innerText = end.toLocaleString('fr-FR');
                    return;
                };
                let startTimestamp = null;
                const easeOutCubic = t => 1 - Math.pow(1 - t, 3);
                
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    const easedProgress = easeOutCubic(progress);
                    el.innerText = Math.floor(easedProgress * (end - start) + start).toLocaleString('fr-FR');
                    
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        el.innerText = end.toLocaleString('fr-FR');
                    }
                };
                window.requestAnimationFrame(step);
            };
            
            const translatePage = () => {
                document.querySelectorAll('[data-key]').forEach(el => {
                    const key = el.dataset.key;
                    if (translations[currentLang][key]) {
                        el.innerText = translations[currentLang][key];
                    }
                });
                if(continentSelect.options.length > 0) continentSelect.options[0].text = translations[currentLang].allContinents;
                if(airlineSelect.options.length > 0) airlineSelect.options[0].text = translations[currentLang].allAirlines;
                aiPredictionTextEl.innerText = translations[currentLang].aiPrediction;
                if(analyticsChart) analyticsChart.setOption({ title: { text: translations[currentLang].covidTimelineTitle } });
            };
            
            const typeWriter = (el, text) => {
                let i = 0;
                el.innerHTML = "";
                const speed = 30;
                function type() {
                    if (i < text.length) {
                        el.innerHTML += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    }
                }
                type();
            };

            const showInsight = () => {
                const randomInsight = insights[currentLang][Math.floor(Math.random() * insights[currentLang].length)];
                typeWriter(insightTextEl, randomInsight);
            };

            const unlockAchievement = (id) => {
                if(achievements[id]) return;
                achievements[id] = true;
                
                const badge = document.getElementById(`badge-${id}`);
                if(badge) badge.classList.add('unlocked');

                const toast = document.createElement('div');
                toast.className = 'achievement-toast';
                toast.textContent = `🏆 ${translations[currentLang]['achievement' + id.charAt(0).toUpperCase() + id.slice(1)]}`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            };

            // --- Data Processing ---
            const num = v => v==null || v==="" ? NaN : parseFloat(String(v).replace(',', '.'));

            function continentByLatLon(lat, lon){
                if (isNaN(lat) || isNaN(lon)) return 'World';
                if (-60<=lat && lat<=12 && -82<=lon && lon<=-34) return 'South America';
                if (  7<=lat && lat<=84 && -170<=lon && lon<=-50) return 'North America';
                if (-35<=lat && lat<=37 && -20<=lon && lon<= 52) return 'Africa';
                if ( 35<=lat && lat<=71 && -25<=lon && lon<= 45) return 'Europe';
                if ( -5<=lat && lat<=80 &&  46<=lon && lon<=180) return 'Asia';
                if (-50<=lat && lat<= 0 && 110<=lon && lon<=180) return 'Oceania';
                return 'World';
            }

            const FIELD = {
                airline:       ['airline','carrier','airline_code'],
                src_iata:      ['src_iata','source_iata','origin','from_iata','src_code'],
                dst_iata:      ['dst_iata','destination_iata','to_iata','dst_code'],
                src_latitude:  ['src_latitude','src_lat','source_latitude','from_lat'],
                src_longitude: ['src_longitude','src_lon','source_longitude','from_lon'],
                dst_latitude:  ['dst_latitude','dst_lat','destination_latitude','to_lat'],
                dst_longitude: ['dst_longitude','dst_lon','destination_longitude','to_lon'],
                src_city:      ['src_city','origin_city'],
                dst_city:      ['dst_city','destination_city'],
                src_country:   ['src_country','origin_country'],
                dst_country:   ['dst_country','destination_country'],
                distance_km:   ['distance_km','distance','km'],
                route_key:     ['route_key','route','od','origin_dest']
            };
            const pick = (row, keys)=> keys.find(k => row[k]!=null && row[k]!=='' ) ? row[keys.find(k=>row[k]!=null && row[k]!=='' )] : null;

            function processData(rows){
                return rows.map(row => {
                const src_lat = num(pick(row, FIELD.src_latitude));
                const src_lon = num(pick(row, FIELD.src_longitude));
                const dst_lat = num(pick(row, FIELD.dst_latitude));
                const dst_lon = num(pick(row, FIELD.dst_longitude));
                const airline = pick(row, FIELD.airline) || 'UNK';
                const src_iata = pick(row, FIELD.src_iata) || '';
                const dst_iata = pick(row, FIELD.dst_iata) || '';
                const rk = pick(row, FIELD.route_key) || `${src_iata} → ${dst_iata}`;

                return {
                    airline, src_iata, dst_iata,
                    src_lat, src_lon, dst_lat, dst_lon,
                    src_continent: continentByLatLon(src_lat, src_lon),
                    dst_continent: continentByLatLon(dst_lat, dst_lon),
                    distance_km: num(pick(row, FIELD.distance_km)),
                    route_key: rk
                };
                }).filter(r =>
                !isNaN(r.src_lat) && !isNaN(r.src_lon) && !isNaN(r.dst_lat) && !isNaN(r.dst_lon)
                );
            }

            function calculateKPIs(data){
                const totalRoutes = data.length;
                const activeAirlines = new Set(data.map(r=>r.airline)).size;
                
                const counts = data.reduce((acc, r) => {
                    acc.airlines[r.airline] = (acc.airlines[r.airline] || 0) + 1;
                    acc.routes[r.route_key] = (acc.routes[r.route_key] || 0) + 1;
                    return acc;
                }, { airlines: {}, routes: {} });

                const topAirlineData = Object.entries(counts.airlines).sort((a,b) => b[1] - a[1])[0] || ['-', 0];
                const busiestRoute = Object.keys(counts.routes).sort((a,b)=>counts.routes[b]-counts.routes[a])[0] || '-';
                const longestRouteData = [...data].sort((a,b) => (b.distance_km || 0) - (a.distance_km || 0))[0];

                animateCounter(document.getElementById('total-routes'), 0, totalRoutes, 1200);
                animateCounter(document.getElementById('active-airlines'), 0, activeAirlines, 1200);
                document.getElementById('top-airline').innerText = topAirlineData[0];
                document.getElementById('busiest-route').innerText = busiestRoute;
                if (longestRouteData) {
                    document.getElementById('longest-route').innerText = `${Math.round(longestRouteData.distance_km).toLocaleString('fr-FR')} km`;
                }
            }

            function populateFilters(data){
                const airlines = [...new Set(data.map(r => r.airline))].sort();
                airlineSelect.innerHTML = `<option value="all">${translations[currentLang].allAirlines}</option>`
                + airlines.map(a=>`<option value="${a}">${a}</option>`).join('');
                
                const conts = [...new Set(data.flatMap(r => [r.src_continent, r.dst_continent]).filter(Boolean))].sort();
                continentSelect.innerHTML = `<option value="all">${translations[currentLang].allContinents}</option>`
                + conts.map(c=>`<option value="${c}">${c}</option>`).join('');
            }
            
            function getFilteredData(){
                const a = airlineSelect.value;
                const c = continentSelect.value;
                if( a !== 'all' || c !== 'all') unlockAchievement('explorer');
                return allRoutesData.filter(r=>{
                    const okA = (a==='all') || (r.airline===a);
                    const okC = (c==='all') || r.src_continent===c || r.dst_continent===c;
                    return okA && okC;
                });
            }

            // --- Charting ---
            const initCharts = () => {
                mapChart = echarts.init(mapChartEl);
                analyticsChart = echarts.init(analyticsChartEl);
            };
            
            function updateMapChart(data){
                const routesToDisplay = godView ? data : data.slice(0, 600);
                const lines = routesToDisplay.map(r=>({
                name: `${r.airline} | ${r.route_key}${r.distance_km?` • ${Math.round(r.distance_km)} km`:''}`,
                coords: [[r.src_lon, r.src_lat],[r.dst_lon, r.dst_lat]]
                }));
                const dots = [
                    ...routesToDisplay.map(r=>({name:`${r.src_iata}`, value:[r.src_lon,r.src_lat]})),
                    ...routesToDisplay.map(r=>({name:`${r.dst_iata}`, value:[r.dst_lon,r.dst_lat]})),
                ];

                mapChart.setOption({
                    backgroundColor:'transparent',
                    tooltip:{ trigger:'item' },
                    geo:{
                        map:'world', roam:true,
                        itemStyle:{ areaColor:'rgba(10,25,41,1)', borderColor:'rgba(0,188,212,.25)'},
                        emphasis:{ itemStyle:{ areaColor:'#14324a'} }
                    },
                    series:[
                        { type:'lines', coordinateSystem:'geo', data:lines, zlevel:1,
                        effect:{ show:true, period:6, trailLength:0.1, symbol:'arrow', symbolSize:5 },
                        lineStyle:{ width:1, opacity:0.45, curveness:0.2,
                            color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(0,188,212,.6)'},{offset:1,color:'rgba(100,181,246,.6)'}])
                        }
                        },
                        { type:'scatter', coordinateSystem:'geo', data:dots, symbolSize:3,
                        itemStyle:{ color:'rgba(0,188,212,.85)'}, zlevel:2 }
                    ]
                }, { notMerge: true });
            }
            
            function initAnalyticsTimeline() {
                 const timelineData = {
                    '2019': { value: 100, label: 'Pic pré-COVID' },
                    '2020': { value: 36, label: 'Chute (-64%)' },
                    '2021': { value: 52, label: 'Reprise Lente' },
                    '2022': { value: 75, label: 'Frontières Ouvertes' },
                    '2023': { value: 91, label: 'Quasi-Normal' },
                    '2024': { value: 105, label: 'Croissance' },
                    '2025': { value: 115, label: 'Prédiction IA' }
                };

                const option = {
                    title: {
                        text: translations[currentLang].covidTimelineTitle,
                        left: 'center',
                        textStyle: { color: 'var(--text-white)' }
                    },
                    tooltip: { trigger: 'axis' },
                    xAxis: {
                        type: 'category',
                        data: Object.keys(timelineData)
                    },
                    yAxis: {
                        type: 'value',
                        name: 'Indice de trafic (Base 100 = 2019)',
                        min: 0,
                        max: 120
                    },
                    series: [{
                        data: Object.values(timelineData).map(d => d.value),
                        type: 'bar',
                        barWidth: '40%',
                        itemStyle: {
                            color: (params) => params.name >= 2024 ? 'var(--accent-green)' : 'var(--accent-cyan)'
                        },
                        markPoint: {
                            symbolSize: 60,
                            data: [
                                { name: 'Point le plus bas', value: 'Chute', xAxis: '2020', yAxis: 36 },
                                { name: 'Prédiction', value: 'Futur', xAxis: '2025', yAxis: 115 }
                            ]
                        },
                        markLine: {
                            data: [{ name: 'Niveau pré-COVID', yAxis: 100 }]
                        }
                    }]
                };
                analyticsChart.setOption(option);
            }
            
            // --- Event Handlers ---
            const handleFilterChange = () => {
                const filteredData = getFilteredData();
                updateMapChart(filteredData);
                calculateKPIs(filteredData);
            };

            const handleTabClick = (isMap) => {
                tabMap.classList.toggle('active', isMap);
                tabAnalytics.classList.toggle('active', !isMap);
                mapChartEl.classList.toggle('hidden', !isMap);
                analyticsChartEl.classList.toggle('hidden', isMap);
                if(!isMap) {
                    analyticsChart.resize();
                    unlockAchievement('analyst');
                }
            };

            const handleKonamiCode = (e) => {
                if (e.key === konamiCode[konamiIndex]) {
                    konamiIndex++;
                    if (konamiIndex === konamiCode.length) {
                        konamiIndex = 0;
                        godView = !godView;
                        const banner = document.createElement('div');
                        banner.className = 'god-view-banner';
                        banner.textContent = `God View ${godView ? 'Activé' : 'Désactivé'}`;
                        document.body.appendChild(banner);
                        unlockAchievement('detective');
                        setTimeout(() => banner.remove(), 3000);
                        handleFilterChange();
                    }
                } else {
                    konamiIndex = 0;
                }
            };

            const createDemoSequence = () => {
                resetFiltersBtn.click();
                mapChart.dispatchAction({ type: 'restore' });

                setTimeout(() => {
                    mapChart.dispatchAction({ type: 'geoRoam', zoom: 1.5, roam: 'move', dx: -200, dy: 100 });
                }, 1000);
                
                setTimeout(() => tabAnalytics.click(), 3000);
                setTimeout(() => tabMap.click(), 5000);
                setTimeout(() => mapChart.dispatchAction({ type: 'restore' }), 7000);
            };

            const main = async () => {
                initCharts();
                translatePage();
                showInsight();

                tabMap.addEventListener('click', () => handleTabClick(true));
                tabAnalytics.addEventListener('click', () => handleTabClick(false));
                airlineSelect.addEventListener('change', handleFilterChange);
                continentSelect.addEventListener('change', handleFilterChange);
                resetFiltersBtn.addEventListener('click', () => {
                    airlineSelect.value = 'all';
                    continentSelect.value = 'all';
                    handleFilterChange();
                    mapChart.dispatchAction({ type: 'restore' });
                });
                langToggle.addEventListener('click', () => {
                    currentLang = currentLang === 'fr' ? 'en' : 'fr';
                    document.getElementById('lang-fr').style.opacity = currentLang === 'fr' ? '1' : '0.5';
                    document.getElementById('lang-en').style.opacity = currentLang === 'en' ? '1' : '0.5';
                    translatePage();
                    showInsight();
                });
                exportPdfBtn.addEventListener('click', () => {
                    const dashboard = document.getElementById('main-dashboard');
                    html2canvas(dashboard, { backgroundColor: '#0a1929' }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('l', 'px', [canvas.width, canvas.height]);
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        pdf.save("airflow-dashboard.pdf");
                    });
                });
                demoBtn.addEventListener('click', createDemoSequence);
                window.addEventListener('keydown', handleKonamiCode);
                window.addEventListener('resize', () => {
                    mapChart.resize();
                    analyticsChart.resize();
                });

                try {
                    const response = await fetch('./routes_front_plus.csv');
                    const csvText  = await response.text();
                    const parsed   = Papa.parse(csvText, { skipEmptyLines:true, header:true, delimiter:"," });
                    allRoutesData  = processData(parsed.data);

                    populateFilters(allRoutesData);
                    calculateKPIs(allRoutesData);
                    updateMapChart(allRoutesData);
                    initAnalyticsTimeline();
                } catch(e){
                    console.error(e);
                    alert("Impossible de charger les données de vol.");
                } finally {
                    loadingOverlay.classList.add('hidden');
                }
            };

            main();
        });
    </script>
</body>
</html>

