<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>AirFlow Dynamics ‚Äî Global Air Traffic Intelligence</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet"/>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://fastly.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://fastly.jsdelivr.net/npm/echarts-gl@2/dist/echarts-gl.min.js"></script>
  <script src="https://fastly.jsdelivr.net/npm/echarts@5/map/js/world.js"></script>
  <script src="https://fastly.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      color-scheme: dark;
      --bg:#0a1929; --bg2:#071421;
      --card:rgba(255,255,255,.06); --card2:rgba(255,255,255,.04);
      --text:#e6f1ff; --muted:#8aa0bf;
      --accent:#00bcd4; --accent2:#64b5f6;
      --border:rgba(255,255,255,.09);
      --dropdown:#0e2236;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1100px 600px at 20% -10%, #173957 0%, transparent 60%),
        radial-gradient(900px 500px at 110% 0%, #0b2a3f 0%, transparent 60%),
        linear-gradient(180deg, var(--bg) 0%, #02070e 100%);
      overflow-x:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1320px;margin:0 auto;padding:24px}
    .header{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background:linear-gradient(135deg,#0f3b4c,#12354a);box-shadow:0 6px 20px rgba(0,0,0,.35)}
    .title{line-height:1.1;font-size:26px;font-weight:900;letter-spacing:.2px}
    .subtitle{font-size:13px;color:var(--muted)}
    .badges{display:flex;gap:8px;flex-wrap:wrap}
    .badge{background:var(--card);border:1px solid var(--border);padding:8px 12px;border-radius:999px}

    .controls{display:flex;gap:8px;align-items:center}
    .btn{border:1px solid var(--border);background:var(--card);color:var(--text);
      border-radius:12px;padding:10px 12px;cursor:pointer;transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,0,0,.25)}
    .btn.primary{background:linear-gradient(135deg,#0f3b4c,#00798f);border-color:#14596a}

    .tabs{display:flex;gap:8px;margin-top:12px}
    .tab{padding:10px 14px;border-radius:999px;background:var(--card);border:1px solid transparent;cursor:pointer}
    .tab.active{background:linear-gradient(135deg,#0f3b4c,#00bcd4);color:#031218;border-color:#1e6272}

    .card{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:16px;
      box-shadow:0 18px 50px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);backdrop-filter:blur(10px)}
    .section-title{font-size:22px;font-weight:900;margin:0 0 10px}

    .filters{display:flex;flex-wrap:wrap;gap:10px;align-items:end}
    .f-group{min-width:220px}
    .label{font-size:12px;color:var(--muted);margin-bottom:6px}
    select{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);color:var(--text);
      background:radial-gradient(120% 120% at 0% 0%, rgba(0,188,212,.08) 0%, rgba(10,25,41,.75) 60%);
      outline:none; appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2300bcd4' viewBox='0 0 16 16'%3E%3Cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
      background-repeat:no-repeat; background-position:right 12px center;
    }
    select:focus{box-shadow:0 0 0 3px rgba(0,188,212,.25)}
    /* ‚úÖ lisible quand le menu s‚Äôouvre */
    select, option{ background-color:var(--dropdown)!important; color:var(--text)!important; }
    option:checked{ background-color:#11425a!important; }

    .grid{display:grid;gap:16px}
    @media(min-width:1000px){ .grid-2{grid-template-columns:2fr 1fr} }

    .chart{height:420px}
    .caption{font-size:12px;color:var(--muted);margin-top:6px}

    .kpis{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}
    .kpi{background:var(--card2);border:1px solid var(--border);border-radius:16px;padding:14px}
    .kpi .k{font-size:12px;color:var(--muted)}
    .kpi .v{font-size:22px;font-weight:900;
      background:linear-gradient(90deg,var(--accent) 0%, var(--accent2) 100%);
      -webkit-background-clip:text;background-clip:text;color:transparent}

    .insights{display:grid;gap:8px}
    .tag{display:inline-flex;gap:6px;align-items:center;padding:8px 10px;border-radius:999px;
      background:rgba(0,188,212,.08);border:1px solid rgba(0,188,212,.25);font-size:12px;color:#cfefff}

    .legend-map{display:flex;gap:12px;align-items:center;font-size:12px;color:var(--muted);margin-top:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:rgba(0,188,212,.9);display:inline-block}
    .line{width:26px;height:2px;background:linear-gradient(90deg,rgba(0,188,212,.7),rgba(100,181,246,.7));display:inline-block}

    .footer{color:var(--muted);text-align:center;margin:24px 0 8px}
    .loading{position:fixed;inset:0;background:rgba(3,12,22,.8);display:grid;place-items:center;z-index:20}
    .spinner{width:48px;height:48px;border-radius:50%;border:7px solid; border-color:#0000 var(--accent);
      animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(180deg)}}
  </style>
</head>

<body>
<div id="loading" class="loading"><div class="spinner"></div></div>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div class="brand">
      <div class="logo">‚úàÔ∏è</div>
      <div>
        <div class="title">AirFlow Dynamics</div>
        <div class="subtitle">Global Air Traffic Intelligence ‚Ä¢ CSV</div>
      </div>
    </div>
    <div class="badges">
      <div class="badge">Visual Synthesis</div>
      <div class="badge">Detailed Analytics</div>
    </div>
    <div class="controls">
      <button id="btn-fr" class="btn">FR</button>
      <button id="btn-en" class="btn">EN</button>
      <button id="btn-pdf" class="btn primary">Export PDF</button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="visual">Visual Synthesis</div>
    <div class="tab" data-tab="analytics">Detailed Analytics</div>
  </div>

  <!-- Filters -->
  <div class="card" style="margin-top:12px">
    <div class="filters">
      <div class="f-group">
        <div class="label" data-i18n="continent">Continent</div>
        <select id="continent">
          <option value="all" data-i18n="allContinents">Tous les continents</option>
        </select>
      </div>
      <div class="f-group">
        <div class="label" data-i18n="airline">Compagnie</div>
        <select id="airline">
          <option value="all" data-i18n="allAirlines">Toutes les compagnies</option>
        </select>
      </div>
      <div style="flex:1"></div>
      <button id="btn-reset" class="btn">Reset</button>
    </div>
  </div>

  <!-- Visual -->
  <div id="view-visual" class="grid grid-2" style="margin-top:16px">
    <div class="card">
      <div class="section-title">Carte & Routes anim√©es</div>
      <div id="chart-map" class="chart"></div>
      <div class="legend-map">
        <span class="line"></span> Routes actives (anim√©es)
        <span class="dot"></span> Hubs / a√©roports
      </div>
      <div class="caption">Astuce : zoomez/d√©placez la carte. Les filtres impactent tous les graphiques.</div>
    </div>
    <div class="card">
      <div class="section-title">KPIs</div>
      <div class="kpis">
        <div class="kpi"><div class="k">Compagnies</div><div id="k_airlines" class="v">‚Äì</div></div>
        <div class="kpi"><div class="k">Routes</div><div id="k_routes" class="v">‚Äì</div></div>
        <div class="kpi"><div class="k">Distance moyenne</div><div id="k_dist" class="v">‚Äì</div></div>
        <div class="kpi"><div class="k">Pays couverts</div><div id="k_countries" class="v">‚Äì</div></div>
        <div class="kpi"><div class="k">% Long-courrier</div><div id="k_long" class="v">‚Äì</div></div>
      </div>
      <div class="section-title" style="margin-top:14px">Insights</div>
      <div id="insights" class="insights">
        <!-- tags dynamiques -->
      </div>
    </div>
  </div>

  <!-- Analytics -->
  <div id="view-analytics" class="card" style="margin-top:16px; display:none">
    <div class="section-title">Analyses d√©taill√©es</div>
    <div id="chart-analytics" class="chart"></div>
    <div class="caption" id="analytics-caption">
      Lisez la timeline en haut : <b>Top compagnies</b> ‚Üí <b>Distribution des distances</b> ‚Üí <b>R√©partition par continent</b>.
      Astuce : utilisez l‚Äôic√¥ne ‚Äútableau‚Äù pour voir les donn√©es sources, et ‚Äúdisquette‚Äù pour exporter l‚Äôimage.
    </div>
  </div>

  <div class="footer">Data OpenFlights (√©chantillon). Racontez votre histoire avec filtres, l√©gendes et annotations.</div>
</div>

<script>
/* ====== I18N ====== */
const I18N = {
  fr: { continent:"Continent", airline:"Compagnie", allContinents:"Tous les continents", allAirlines:"Toutes les compagnies",
        "Visual Synthesis":"Synth√®se visuelle", "Detailed Analytics":"Analyses d√©taill√©es", "Export PDF":"Exporter PDF",
        insights:{
          topHub:"Hub principal",
          corridor:"Corridor dominant",
          median:"M√©diane distance",
          p90:"P90 distance",
          longShare:"Long-courrier"
        }},
  en: { continent:"Continent", airline:"Airline", allContinents:"All Continents", allAirlines:"All Airlines",
        "Visual Synthesis":"Visual Synthesis", "Detailed Analytics":"Detailed Analytics", "Export PDF":"Export PDF",
        insights:{
          topHub:"Top hub",
          corridor:"Dominant corridor",
          median:"Median distance",
          p90:"P90 distance",
          longShare:"Long-haul"
        }}
};
let LANG = localStorage.getItem('lang') || 'fr';
function t(key){ return (I18N[LANG]&&I18N[LANG][key]) || key; }
function applyI18n(){
  document.querySelectorAll('[data-i18n]').forEach(el=> el.textContent = t(el.dataset.i18n) );
  document.getElementById('btn-pdf').textContent = t("Export PDF");
}

/* ====== Helpers & State ====== */
const num = v => (v==null||v==="") ? NaN : parseFloat(String(v).replace(',','.'));
function continentByLatLon(lat, lon){
  if (isNaN(lat)||isNaN(lon)) return 'World';
  if (-60<=lat && lat<=12 && -82<=lon && lon<=-34) return 'South America';
  if (  7<=lat && lat<=84 && -170<=lon && lon<=-50) return 'North America';
  if (-35<=lat && lat<=37 && -20<=lon && lon<= 52) return 'Africa';
  if ( 35<=lat && lat<=71 && -25<=lon && lon<= 45) return 'Europe';
  if ( -5<=lat && lat<=80 &&  46<=lon && lon<=180) return 'Asia';
  if (-50<=lat && lat<= 0 && 110<=lon && lon<=180) return 'Oceania';
  return 'World';
}
function processRow(row){
  const r = {
    airline: row.airline || 'UNK',
    src_iata: row.src_iata || '', dst_iata: row.dst_iata || '',
    src_city: row.src_city || '', dst_city: row.dst_city || '',
    src_country: row.src_country || '', dst_country: row.dst_country || '',
    src_lat: num(row.src_latitude), src_lon: num(row.src_longitude),
    dst_lat: num(row.dst_latitude), dst_lon: num(row.dst_longitude),
    distance_km: num(row.distance_km),
    route_key: row.route_key || ''
  };
  r.src_continent = continentByLatLon(r.src_lat, r.src_lon);
  r.dst_continent = continentByLatLon(r.dst_lat, r.dst_lon);
  return r;
}
const state = { routes:[], continent:'all', airline:'all' };

/* ====== Charts ====== */
const chart = {
  map: echarts.init(document.getElementById('chart-map')),
  analytics: echarts.init(document.getElementById('chart-analytics'))
};
window.addEventListener('resize', ()=> Object.values(chart).forEach(c=>c.resize()) );

/* ====== KPIs & Insights ====== */
function fmtKm(v){ return Math.round(v).toLocaleString(LANG)+' km'; }
function quantile(values, q){
  const a = values.slice().sort((x,y)=>x-y); if(!a.length) return 0;
  const pos = (a.length-1)*q, base = Math.floor(pos), rest = pos-base;
  return a[base] + (a[base+1]-a[base]||0)*rest;
}
function updateKPIs(){
  const r = filteredRoutes();
  const airlines = new Set(r.map(d=>d.airline));
  const countries = new Set(r.flatMap(d=>[d.src_country,d.dst_country]));
  const dists = r.filter(d=>isFinite(d.distance_km)).map(d=>d.distance_km);
  const avg = dists.length? dists.reduce((s,d)=>s+d,0)/dists.length : 0;
  const med = dists.length? quantile(dists, .5) : 0;
  const p90 = dists.length? quantile(dists, .9) : 0;
  const longShare = r.length? Math.round(100*r.filter(d=>d.distance_km>3500).length/r.length) : 0;

  document.getElementById('k_airlines').textContent = airlines.size;
  document.getElementById('k_routes').textContent = r.length.toLocaleString(LANG);
  document.getElementById('k_countries').textContent = countries.size;
  document.getElementById('k_dist').textContent = avg? fmtKm(avg) : '‚Äì';
  document.getElementById('k_long').textContent = longShare+'%';

  // Insights
  const bySrc = {}; r.forEach(x=> bySrc[x.src_iata || x.src_city || 'UNK'] = (bySrc[x.src_iata || x.src_city || 'UNK']||0)+1 );
  const topHub = Object.entries(bySrc).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äì';
  const byCorr = {}; r.forEach(x=>{
    const key = (x.src_continent||'World')+'‚Üí'+(x.dst_continent||'World');
    byCorr[key]=(byCorr[key]||0)+1;
  });
  const topCorr = Object.entries(byCorr).sort((a,b)=>b[1]-a[1])[0]?.[0] || '‚Äì';

  const wrap = document.getElementById('insights');
  wrap.innerHTML = '';
  const add = (icon, label, value) => {
    const el = document.createElement('div'); el.className='tag';
    el.innerHTML = `${icon} <b>${label}:</b>&nbsp;${value}`;
    wrap.appendChild(el);
  };
  add('üõ´', t('insights').topHub, topHub);
  add('üåç', t('insights').corridor, topCorr);
  add('üìè', t('insights').median, fmtKm(med));
  add('üéØ', t('insights').p90, fmtKm(p90));
  add('üöÄ', t('insights').longShare, longShare+'%');
}

/* ====== Map ====== */
function filteredRoutes(){
  return state.routes.filter(r=>{
    const a = state.airline==='all' || r.airline===state.airline;
    const c = state.continent==='all' || r.src_continent===state.continent || r.dst_continent===state.continent;
    return a && c;
  });
}
function renderMap(){
  const data = filteredRoutes().slice(0, 900);
  const lines = data.map(r=>({
    name: `${r.airline} | ${r.src_iata} ‚Üí ${r.dst_iata}${isFinite(r.distance_km)?` ‚Ä¢ ${Math.round(r.distance_km)} km`:''}`,
    coords: [[r.src_lon,r.src_lat],[r.dst_lon,r.dst_lat]]
  }));
  // unique dots
  const dotKey = (lon,lat)=>lon.toFixed(2)+','+lat.toFixed(2);
  const dotMap = new Map();
  data.forEach(r=>{
    const aK = dotKey(r.src_lon,r.src_lat), bK = dotKey(r.dst_lon,r.dst_lat);
    if (!dotMap.has(aK)) dotMap.set(aK,{name:`${r.src_city||r.src_iata} (${r.src_country})`, value:[r.src_lon,r.src_lat]});
    if (!dotMap.has(bK)) dotMap.set(bK,{name:`${r.dst_city||r.dst_iata} (${r.dst_country})`, value:[r.dst_lon,r.dst_lat]});
  });

  chart.map.setOption({
    backgroundColor:'transparent',
    toolbox:{right:10, feature:{ saveAsImage:{}, dataView:{} }},
    tooltip:{ trigger:'item' },
    geo:{
      map:'world', roam:true,
      itemStyle:{ areaColor:'#0a1929', borderColor:'rgba(0,188,212,.25)' },
      emphasis:{ itemStyle:{ areaColor:'#14324a' } }
    },
    series:[
      { type:'lines', coordinateSystem:'geo', data:lines, zlevel:1,
        effect:{ show:true, period:6, trailLength:0.1, symbol:'arrow', symbolSize:5 },
        lineStyle:{ width:1, opacity:0.48, curveness:0.25,
          color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'rgba(0,188,212,.7)'},{offset:1,color:'rgba(100,181,246,.7)'}]) } },
      { type:'scatter', coordinateSystem:'geo', data:[...dotMap.values()], symbolSize:3, zlevel:2,
        itemStyle:{ color:'rgba(0,188,212,.9)' } }
    ]
  });
}

/* ====== Analytics (Timeline 3 vues) ====== */
function buildAnalyticsOptions(){
  const data = filteredRoutes();

  // 1) Top airlines
  const topMap = {}; data.forEach(r=> topMap[r.airline]=(topMap[r.airline]||0)+1 );
  const topArr = Object.entries(topMap).sort((a,b)=>b[1]-a[1]).slice(0,12);
  const topOpt = {
    title:{ text:'Top compagnies (par nombre de routes)' },
    legend:{ show:true }, tooltip:{}, toolbox:{right:10, feature:{saveAsImage:{}, dataView:{}} },
    grid:{left:60,right:20,top:40,bottom:50},
    xAxis:{ type:'category', data: topArr.map(d=>d[0]), axisLabel:{ interval:0, rotate:30 }},
    yAxis:{ type:'value', name:'Routes' },
    series:[{ type:'bar', name:'Routes', data: topArr.map(d=>d[1]),
      itemStyle:{ color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#00bcd4'},{offset:1,color:'#64b5f6'}]) }, barMaxWidth:28 }]
  };

  // 2) Distance distribution (bins)
  const dists = data.filter(d=>isFinite(d.distance_km)).map(d=>d.distance_km);
  const bins = [0,500,1000,1500,2000,3000,4000,6000,8000,10000,15000];
  const labels = bins.slice(0,-1).map((b,i)=>`${b}-${bins[i+1]}`);
  const counts = new Array(labels.length).fill(0);
  dists.forEach(x=>{
    for (let i=0;i<bins.length-1;i++){ if (x>=bins[i] && x<bins[i+1]) { counts[i]++; break; } }
  });
  const distOpt = {
    title:{ text:'Distribution des distances (km)' },
    legend:{ show:true }, tooltip:{ trigger:'axis' }, toolbox:{right:10, feature:{saveAsImage:{}, dataView:{}} },
    grid:{left:60,right:20,top:40,bottom:50},
    xAxis:{ type:'category', data: labels, axisLabel:{ rotate:30 }},
    yAxis:{ type:'value', name:'Routes' },
    series:[{ type:'bar', name:'Routes', data: counts,
      itemStyle:{ color:new echarts.graphic.LinearGradient(0,0,0,1,[{offset:0,color:'#64b5f6'},{offset:1,color:'#00bcd4'}]) }, barMaxWidth:24 }]
  };

  // 3) Destination continents (donut)
  const byCont = {}; data.forEach(r=> byCont[r.dst_continent]=(byCont[r.dst_continent]||0)+1 );
  const contData = Object.entries(byCont).map(([name,value])=>({name,value})).sort((a,b)=>b.value-a.value);
  const contOpt = {
    title:{ text:'R√©partition par continent (destination)' },
    legend:{ bottom:0, textStyle:{ color:'#cfefff' } }, tooltip:{ trigger:'item', formatter:'{b}: {c} ({d}%)' },
    toolbox:{right:10, feature:{saveAsImage:{}, dataView:{}} },
    series:[{ type:'pie', radius:['42%','70%'], center:['50%','50%'], name:'Part',
      label:{ color:'#e6f1ff' }, data: contData }]
  };

  // Timeline with 3 options
  return {
    baseOption:{
      timeline:{
        axisType:'category',
        data:['Top Airlines','Distances','Continents'],
        autoPlay:true, playInterval:4000, bottom:0, label:{ color:'#cfefff' }
      },
      series:[{},{},{}]
    },
    options:[ topOpt, distOpt, contOpt ]
  };
}
function renderAnalytics(){
  const opt = buildAnalyticsOptions();
  chart.analytics.setOption(opt, true);
}

/* ====== Export PDF ====== */
function exportPDF(){
  const opt = { filename:'airflow-dashboard.pdf', image:{type:'jpeg',quality:0.96}, html2canvas:{scale:1.2},
                jsPDF:{unit:'px',format:'a4',orientation:'landscape'} };
  html2pdf().set(opt).from(document.querySelector('.container')).save();
}

/* ====== Boot ====== */
async function boot(){
  applyI18n();
  document.getElementById('btn-fr').onclick=()=>{LANG='fr';localStorage.setItem('lang','fr');applyI18n();renderAnalytics();}
  document.getElementById('btn-en').onclick=()=>{LANG='en';localStorage.setItem('lang','en');applyI18n();renderAnalytics();}
  document.getElementById('btn-pdf').onclick=exportPDF;

  // Tabs switching
  document.querySelectorAll('.tab').forEach(tab=>{
    tab.onclick=()=>{
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      const v = tab.dataset.tab;
      document.getElementById('view-visual').style.display = v==='visual'?'grid':'none';
      document.getElementById('view-analytics').style.display = v==='analytics'?'block':'none';
      chart.map.resize(); chart.analytics.resize();
    };
  });

  // Filters
  const selCont = document.getElementById('continent');
  const selAir  = document.getElementById('airline');
  document.getElementById('btn-reset').onclick=()=>{ selCont.value='all'; selAir.value='all'; state.continent='all'; state.airline='all'; refresh(); };

  selCont.onchange=e=>{state.continent=e.target.value; refresh();}
  selAir.onchange =e=>{state.airline  =e.target.value; refresh();}

  // Load CSV
  const resp = await fetch('./routes_front_plus.csv');
  const txt  = await resp.text();
  const parsed = Papa.parse(txt, { header:true, skipEmptyLines:true }); // auto delimiter
  state.routes = parsed.data.map(processRow).filter(r=>!isNaN(r.src_lat)&&!isNaN(r.src_lon)&&!isNaN(r.dst_lat)&&!isNaN(r.dst_lon));

  // Populate filters
  const uniqA = [...new Set(state.routes.map(r=>r.airline))].sort();
  selAir.innerHTML = `<option value="all">${t('allAirlines')}</option>` + uniqA.map(a=>`<option>${a}</option>`).join('');
  const uniqC = [...new Set(state.routes.flatMap(r=>[r.src_continent,r.dst_continent]))].filter(Boolean).sort();
  selCont.innerHTML = `<option value="all">${t('allContinents')}</option>` + uniqC.map(c=>`<option>${c}</option>`).join('');

  refresh();
  document.getElementById('loading').style.display='none';
}
function refresh(){ updateKPIs(); renderMap(); renderAnalytics(); }

boot();
</script>
</body>
</html>
